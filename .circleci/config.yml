version: 2
jobs:
  staging:
    working_directory: /project/workplace/
    docker:
      - image: lakhanmandloi/sunbird-ubuntu-full
    steps:
    
      #Checkout
      - checkout
            
      # Run Build command
      - type: shell
        command: |
          bundle exec jekyll build
   
      # Deploy to s3 bucket
      - type: shell
        command: |
           bundle exec s3_website push
          
  prod:
    working_directory: /project/workspace/
    docker:
      - image: lakhanmandloi/sunbird-ubuntu-full
    steps:
      
      #Checkout
      - checkout
          
      # Add SSH Key   
      - add_ssh_keys:
          fingerprints:
            - "c3:11:0a:22:15:51:43:8f:70:b8:76:5a:5a:59:07:49"
      #Add User
      - type: shell
        command: |
          git config --global user.email "lakhan_m@tekditechnologies.com"
          git config --global user.name "Lakhan Mandloi"
      
      # Pull Code from staging site
      - type: shell
        command: |
          cd ..
          mkdir downloads
          cd downloads
          aws s3 sync --delete s3://sunbird-trial/ .
           
      # Deploy to Gitpages
      - type: shell
        command: |
          cd ..
          mkdir deploy
          cd deploy
          git clone git@github.com:lakhanmandloi/lakhanmandloi.github.io.git
          cd lakhanmandloi.github.io
          git checkout master
          cp -R .git/ ../
          rm -rf *
          cd ..
          cp -R ../downloads/* lakhanmandloi.github.io/
          cp -R .git/ lakhanmandloi.github.io/
          cd lakhanmandloi.github.io/
          git add -A
          git commit -m "$CIRCLE_TAG"
          git push origin master
          
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - staging
      - hold:
          type: approval
          requires:
              - staging
      - prod:
          requires:
              - hold
